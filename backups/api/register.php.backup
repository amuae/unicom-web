<?php
/**
 * 用户注册 API
 * 支持公开注册和激活码注册
 */

require_once __DIR__ . '/../classes/ApiHelper.php';
require_once __DIR__ . '/../classes/Database.php';
require_once __DIR__ . '/../classes/User.php';
require_once __DIR__ . '/../admin/ActivationCode.php';

ApiHelper::init();

// 处理GET请求（查询系统模式）
if (ApiHelper::getMethod() === 'GET') {
    $action = $_GET['action'] ?? '';
    
    if ($action === 'check_mode') {
        try {
            $db = Database::getInstance();
            $siteMode = $db->querySingle("SELECT value FROM site_config WHERE key = 'site_mode'") ?: 'public';
            ApiHelper::success(['mode' => $siteMode]);
        } catch (Exception $e) {
            ApiHelper::error('查询失败: ' . $e->getMessage());
        }
    }
    
    ApiHelper::error('不支持的操作');
}

// POST请求处理
ApiHelper::checkMethod('POST');

$input = ApiHelper::getInput();

// 获取参数
$mobile = trim($input['mobile'] ?? '');
$authType = $input['auth_type'] ?? 'full';
$appid = trim($input['appid'] ?? '');
$tokenOnline = trim($input['token_online'] ?? '');
$cookie = trim($input['cookie'] ?? '');
$activationCode = trim($input['activation_code'] ?? '');

// 验证手机号
ApiHelper::validateMobile($mobile);

// 验证认证信息
if ($authType === 'full') {
    ApiHelper::requireParams($input, ['appid', 'token_online']);
} else if ($authType === 'cookie') {
    ApiHelper::requireParams($input, ['cookie']);
} else {
    ApiHelper::error('无效的认证类型');
}

try {
    $db = Database::getInstance();
    
    // 检查手机号是否已存在
    if (User::findByMobile($mobile)) {
        ApiHelper::error('该手机号已注册');
    }
    
    // 检查系统模式
    $siteMode = $db->querySingle("SELECT value FROM site_config WHERE key = 'site_mode'") ?: 'public';
    $userType = 'beta';
    
    if ($siteMode === 'private') {
        if (empty($activationCode)) {
            ApiHelper::error('私有模式下需要激活码');
        }
        
        $validation = ActivationCode::validate($activationCode);
        if (!$validation['success']) {
            ApiHelper::error($validation['message']);
        }
        
        $userType = 'activated';
    }
    
    // 创建用户
    if ($authType === 'full') {
        $result = User::createWithFullAuth($mobile, $appid, $tokenOnline, '');
    } else {
        $result = User::createWithCookie($mobile, $cookie, '');
    }
    
    if (!$result['success']) {
        echo json_encode(['success' => false, 'message' => $result['message']], JSON_UNESCAPED_UNICODE);
        
    // 更新用户类型（如果使用了激活码）
    if ($siteMode === 'private' && !empty($activationCode)) {
        $stmt = $db->prepare("UPDATE users SET user_type = :type WHERE id = :id");
        $stmt->bindValue(':type', $userType, SQLITE3_TEXT);
        $stmt->bindValue(':id', $userId, SQLITE3_INTEGER);
        $stmt->execute();
        ActivationCode::use($activationCode, $userId);
    }
    
    // 生成访问URL
    $user = User::findById($userId);
    $protocol = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') ? 'https' : 'http';
    $accessUrl = "{$protocol}://{$_SERVER['HTTP_HOST']}/views/index.html?token={$user->accessToken}";
    
    ApiHelper::success([
        'mobile' => $mobile,
        'access_token' => $user->accessToken,
        'query_url' => $accessUrl,
        'access_url' => $accessUrl,
        'user_type' => $userType
    ], '注册成功');
    
} catch (Exception $e) {
    ApiHelper::error('注册失败: ' . $e->getMessage());
}


<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†é¢æ¿ - è”é€šæµé‡ç›‘æ§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .user-info {
            font-size: 14px;
        }
        
        .btn-logout {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .card-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h2 {
            font-size: 18px;
            color: #333;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: opacity 0.2s;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn-secondary {
            background: #e0e7ff;
            color: #667eea;
        }
        
        .card-body {
            padding: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        td {
            font-size: 14px;
            color: #666;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-success {
            background: #d1f4e0;
            color: #0d894f;
        }
        
        .badge-danger {
            background: #fee;
            color: #c33;
        }
        
        .actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .btn-small:hover {
            opacity: 0.8;
        }
        
        .btn-edit {
            background: #e0e7ff;
            color: #667eea;
        }
        
        .btn-delete {
            background: #fee;
            color: #c33;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-size: 18px;
            color: #333;
        }
        
        .close {
            font-size: 24px;
            color: #999;
            cursor: pointer;
            border: none;
            background: none;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 6px;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-hint {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* æ ‡ç­¾é¡µæ ·å¼ */
        .admin-tab {
            flex: 1;
            padding: 16px 20px;
            border: none;
            background: none;
            color: #999;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .admin-tab:hover {
            color: #667eea;
            background: #f8f9ff;
        }
        
        .admin-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f8f9ff;
        }
        
        .admin-tab span:first-child {
            font-size: 20px;
        }
        
        .tab-content {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <span>ğŸ“±</span>
            è”é€šæµé‡ç›‘æ§ç®¡ç†é¢æ¿
        </h1>
        <div class="header-right">
            <div class="user-info">
                æ¬¢è¿ï¼Œ<strong id="adminUsername">ç®¡ç†å‘˜</strong>
            </div>
            <button class="btn-logout" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
    </div>
    
    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                <div class="stat-value" id="totalUsers">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ´»è·ƒç”¨æˆ·</div>
                <div class="stat-value" id="activeUsers">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ä»Šæ—¥æŸ¥è¯¢</div>
                <div class="stat-value" id="todayQueries">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ç³»ç»ŸçŠ¶æ€</div>
                <div class="stat-value" style="font-size: 24px; color: #0d894f;">è¿è¡Œä¸­</div>
            </div>
        </div>
        
        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div style="background: white; border-radius: 12px; padding: 0; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden;">
            <div style="display: flex; border-bottom: 2px solid #f0f0f0;">
                <button class="admin-tab active" onclick="switchAdminTab('users')" id="tabUsers">
                    <span>ğŸ‘¥</span>
                    <span>ç”¨æˆ·ç®¡ç†</span>
                </button>
                <button class="admin-tab" onclick="switchAdminTab('activation')" id="tabActivation">
                    <span>ğŸ«</span>
                    <span>æ¿€æ´»ç </span>
                </button>
                <button class="admin-tab" onclick="switchAdminTab('admins')" id="tabAdmins">
                    <span>ğŸ‘¨â€ğŸ’¼</span>
                    <span>ç®¡ç†å‘˜</span>
                </button>
                <button class="admin-tab" onclick="switchAdminTab('settings')" id="tabSettings">
                    <span>âš™ï¸</span>
                    <span>ç½‘ç«™è®¾ç½®</span>
                </button>
            </div>
        </div>
        
        <!-- ç”¨æˆ·ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="usersTab" class="tab-content">
        <div class="card">
            <div class="card-header">
                <h2>ç”¨æˆ·ç®¡ç†</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="showSystemCheck()" style="background: #ff9800;">ğŸ” ç³»ç»Ÿè‡ªæ£€</button>
                    <button class="btn" onclick="showAddUserModal()">â• æ·»åŠ ç”¨æˆ·</button>
                </div>
            </div>
            <div class="card-body">
                <div id="userTableLoading" class="loading">
                    åŠ è½½ä¸­...
                </div>
                <div id="userTableContainer" style="display: none;">
                    <table id="userTable">
                        <thead>
                            <tr>
                                <th>æ‰‹æœºå·</th>
                                <th>è®¤è¯ç±»å‹</th>
                                <th>è®¿é—®Token</th>
                                <th>çŠ¶æ€</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>å¤‡æ³¨</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                        </tbody>
                    </table>
                </div>
                <div id="userTableEmpty" class="empty" style="display: none;">
                    æš‚æ— ç”¨æˆ·æ•°æ®
                </div>
            </div>
        </div>
        </div>
        </div>
        <!-- ç”¨æˆ·ç®¡ç†æ ‡ç­¾é¡µç»“æŸ -->
        
        <!-- æ¿€æ´»ç ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="activationTab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2>æ¿€æ´»ç ç®¡ç†</h2>
                    <button class="btn" onclick="showGenerateCodeModal()">â• ç”Ÿæˆæ¿€æ´»ç </button>
                </div>
                <div class="card-body">
                    <!-- ç»Ÿè®¡å¡ç‰‡ -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #f8f9ff; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: #999; margin-bottom: 5px;">æ€»æ¿€æ´»ç </div>
                            <div style="font-size: 24px; font-weight: 600; color: #667eea;" id="codeTotal">0</div>
                        </div>
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: #999; margin-bottom: 5px;">æœªä½¿ç”¨</div>
                            <div style="font-size: 24px; font-weight: 600; color: #4caf50;" id="codeUnused">0</div>
                        </div>
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: #999; margin-bottom: 5px;">å·²ä½¿ç”¨</div>
                            <div style="font-size: 24px; font-weight: 600; color: #ff9800;" id="codeUsed">0</div>
                        </div>
                        <div style="background: #ffebee; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: #999; margin-bottom: 5px;">å·²è¿‡æœŸ</div>
                            <div style="font-size: 24px; font-weight: 600; color: #f56c6c;" id="codeExpired">0</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                        <button class="btn-small" onclick="deleteSelectedCodes()" style="background: #f56c6c; color: white;">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­</button>
                        <button class="btn-small" onclick="exportCodes()" style="background: #4caf50; color: white;">ğŸ“¥ å¯¼å‡ºæ¿€æ´»ç </button>
                    </div>
                    
                    <div id="codeTableContainer">
                        <table id="codeTable">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" onclick="toggleAllCodes(this)"></th>
                                    <th>æ¿€æ´»ç </th>
                                    <th>çŠ¶æ€</th>
                                    <th>ä½¿ç”¨è€…</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>ä½¿ç”¨æ—¶é—´</th>
                                    <th>å¤‡æ³¨</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="codeTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- æ¿€æ´»ç æ ‡ç­¾é¡µç»“æŸ -->
        
        <!-- ç®¡ç†å‘˜ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="adminsTab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2>ç®¡ç†å‘˜ç®¡ç†</h2>
                </div>
                <div class="card-body">
                    <table id="adminTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ç”¨æˆ·å</th>
                                <th>é‚®ç®±</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="adminTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- ç®¡ç†å‘˜æ ‡ç­¾é¡µç»“æŸ -->
        
        <!-- ç½‘ç«™è®¾ç½®æ ‡ç­¾é¡µ -->
        <div id="settingsTab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2>ç½‘ç«™è®¾ç½®</h2>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">è¿è¥æ¨¡å¼</label>
                        <select class="form-select" id="siteMode" onchange="updateSiteMode()" style="max-width: 300px;">
                            <option value="public">å…¬å¼€æ³¨å†Œ</option>
                            <option value="private">ç§æœ‰æ¨¡å¼</option>
                        </select>
                        <div class="form-hint">
                            å…¬å¼€æ¨¡å¼ï¼šä»»ä½•äººéƒ½å¯ä»¥æ³¨å†Œæ·»åŠ ç”¨æˆ·ï¼ˆæ ‡è®°ä¸ºå…¬æµ‹ç”¨æˆ·ï¼‰<br>
                            ç§æœ‰æ¨¡å¼ï¼šåªæœ‰æŒæœ‰æ¿€æ´»ç çš„äººæ‰èƒ½æ·»åŠ ç”¨æˆ·ï¼ˆæ ‡è®°ä¸ºæ¿€æ´»ç ç”¨æˆ·ï¼‰
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #f8f9ff; border-radius: 8px;">
                        <h3 style="margin-bottom: 15px; color: #667eea;">ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
                        <ul style="line-height: 2; color: #666;">
                            <li><strong>å…¬å¼€æ³¨å†Œæ¨¡å¼ï¼š</strong>é€‚åˆå†…æµ‹é˜¶æ®µï¼Œæ‰€æœ‰ç”¨æˆ·æ ‡è®°ä¸º"å…¬æµ‹ç”¨æˆ·"</li>
                            <li><strong>ç§æœ‰æ¨¡å¼ï¼š</strong>é€‚åˆæ­£å¼è¿è¥ï¼Œä½¿ç”¨ç”±ç®¡ç†å‘˜ç”Ÿæˆçš„å¡å¯†æ¥æ¿€æ´»ï¼Œç”¨æˆ·æ ‡è®°ä¸º"æ¿€æ´»ç ç”¨æˆ·"</li>
                            <li>å¯ä»¥éšæ—¶åˆ‡æ¢æ¨¡å¼ï¼Œå·²æœ‰ç”¨æˆ·çš„æ ‡è®°ä¸ä¼šæ”¹å˜</li>
                            <li>å»ºè®®ï¼šå†…æµ‹æœŸä½¿ç”¨å…¬å¼€æ¨¡å¼ï¼Œæ­£å¼ä¸Šçº¿ååˆ‡æ¢åˆ°ç§æœ‰æ¨¡å¼</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- ç½‘ç«™è®¾ç½®æ ‡ç­¾é¡µç»“æŸ -->
    </div>
    
    <!-- ç”Ÿæˆæ¿€æ´»ç æ¨¡æ€æ¡† -->
    <div class="modal" id="generateCodeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç”Ÿæˆæ¿€æ´»ç </h3>
                <button class="close" onclick="closeGenerateCodeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ç”Ÿæˆæ•°é‡ *</label>
                    <input type="number" class="form-input" id="generateCount" value="1" min="1" max="100">
                    <div class="form-hint">ä¸€æ¬¡æœ€å¤šç”Ÿæˆ100ä¸ªæ¿€æ´»ç </div>
                </div>
                <div class="form-group">
                    <label class="form-label">å¤‡æ³¨</label>
                    <input type="text" class="form-input" id="generateRemark" placeholder="å¯é€‰ï¼Œç”¨äºæ ‡è¯†è¿™æ‰¹æ¿€æ´»ç çš„ç”¨é€”">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeGenerateCodeModal()">å–æ¶ˆ</button>
                <button class="btn" onclick="generateCodes()">ç”Ÿæˆ</button>
            </div>
        </div>
    </div>
    
    <!-- ä¿®æ”¹ç®¡ç†å‘˜ç”¨æˆ·åæ¨¡æ€æ¡† -->
    <div class="modal" id="editAdminUsernameModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ä¿®æ”¹ç”¨æˆ·å</h3>
                <button class="close" onclick="closeEditAdminUsernameModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editAdminId">
                <div class="form-group">
                    <label class="form-label">æ–°ç”¨æˆ·å *</label>
                    <input type="text" class="form-input" id="editAdminUsername" placeholder="3-20ä¸ªå­—ç¬¦">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditAdminUsernameModal()">å–æ¶ˆ</button>
                <button class="btn" onclick="saveAdminUsername()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- ä¿®æ”¹ç®¡ç†å‘˜å¯†ç æ¨¡æ€æ¡† -->
    <div class="modal" id="editAdminPasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ä¿®æ”¹å¯†ç </h3>
                <button class="close" onclick="closeEditAdminPasswordModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editPasswordAdminId">
                <div class="form-group">
                    <label class="form-label">æ–°å¯†ç  *</label>
                    <input type="password" class="form-input" id="editAdminPassword" placeholder="è‡³å°‘6ä¸ªå­—ç¬¦">
                </div>
                <div class="form-group">
                    <label class="form-label">ç¡®è®¤å¯†ç  *</label>
                    <input type="password" class="form-input" id="editAdminPasswordConfirm" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditAdminPasswordModal()">å–æ¶ˆ</button>
                <button class="btn" onclick="saveAdminPassword()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ ç”¨æˆ·</h3>
                <button class="close" onclick="closeAddUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">è®¤è¯ç±»å‹ *</label>
                    <select class="form-select" id="authType" onchange="toggleAuthFields()">
                        <option value="full">å®Œæ•´è®¤è¯ï¼ˆæ‰‹æœºå·+APPID+TOKENï¼‰</option>
                        <option value="cookie">Cookieè®¤è¯ï¼ˆæ‰‹æœºå·+Cookieï¼‰</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">æ‰‹æœºå· *</label>
                    <input type="text" class="form-input" id="mobile" placeholder="11ä½æ‰‹æœºå·" maxlength="11">
                    <div class="form-hint">è¯·è¾“å…¥11ä½æ‰‹æœºå·</div>
                </div>
                
                <div id="fullAuthFields">
                    <div class="form-group">
                        <label class="form-label">APPID *</label>
                        <input type="text" class="form-input" id="appid" placeholder="è”é€šAPPID">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">TOKEN_ONLINE *</label>
                        <input type="text" class="form-input" id="tokenOnline" placeholder="è”é€šTOKEN">
                    </div>
                </div>
                
                <div id="cookieAuthFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Cookie *</label>
                        <textarea class="form-textarea" id="cookie" placeholder="è¯·ç²˜è´´å®Œæ•´çš„Cookieå­—ç¬¦ä¸²"></textarea>
                        <div class="form-hint">ä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­å¤åˆ¶Cookie</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">å¤‡æ³¨</label>
                    <input type="text" class="form-input" id="remark" placeholder="å¯é€‰ï¼Œç”¨äºæ ‡è¯†ç”¨æˆ·">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddUserModal()">å–æ¶ˆ</button>
                <button class="btn" onclick="addUser()">æ·»åŠ </button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal" id="editUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¼–è¾‘ç”¨æˆ·</h3>
                <button class="close" onclick="closeEditUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editUserId">
                <input type="hidden" id="editUserToken">
                
                <div class="form-group">
                    <label class="form-label">æ‰‹æœºå·</label>
                    <input type="text" class="form-input" id="editMobile" placeholder="11ä½æ‰‹æœºå·" readonly style="background-color: #f5f5f5;">
                    <div class="form-hint">æ‰‹æœºå·ä¸å¯ä¿®æ”¹</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">è®¤è¯ç±»å‹ *</label>
                    <select class="form-select" id="editAuthType" onchange="toggleEditAuthFields()">
                        <option value="full">å®Œæ•´è®¤è¯ï¼ˆæ‰‹æœºå·+APPID+TOKENï¼‰</option>
                        <option value="cookie">Cookieè®¤è¯ï¼ˆæ‰‹æœºå·+Cookieï¼‰</option>
                    </select>
                </div>
                
                <div id="editFullAuthFields">
                    <div class="form-group">
                        <label class="form-label">APPID *</label>
                        <input type="text" class="form-input" id="editAppid" placeholder="è”é€šAPPID">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">TOKEN_ONLINE *</label>
                        <input type="text" class="form-input" id="editTokenOnline" placeholder="è”é€šTOKEN">
                    </div>
                </div>
                
                <div id="editCookieAuthFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Cookie *</label>
                        <textarea class="form-textarea" id="editCookie" placeholder="è¯·ç²˜è´´å®Œæ•´çš„Cookieå­—ç¬¦ä¸²"></textarea>
                        <div class="form-hint">ä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­å¤åˆ¶Cookie</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">å¤‡æ³¨</label>
                    <input type="text" class="form-input" id="editRemark" placeholder="å¯é€‰ï¼Œç”¨äºæ ‡è¯†ç”¨æˆ·">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditUserModal()">å–æ¶ˆ</button>
                <button class="btn" onclick="saveUserEdit()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ç³»ç»Ÿè‡ªæ£€æ¨¡æ€æ¡† -->
    <div class="modal" id="systemCheckModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>ğŸ” ç³»ç»Ÿè‡ªæ£€</h3>
                <button class="close" onclick="closeSystemCheck()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="checkLoading" style="text-align: center; padding: 20px;">
                    <div style="font-size: 32px; margin-bottom: 10px;">â³</div>
                    <div>æ­£åœ¨æ£€æµ‹...</div>
                </div>
                
                <div id="checkResult" style="display: none;">
                    <!-- å¥åº·çŠ¶æ€ -->
                    <div id="healthStatus" style="padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-size: 16px; font-weight: 600;"></div>
                    
                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #f8f9ff; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 12px; color: #999; margin-bottom: 5px;">æ•°æ®åº“ç”¨æˆ·æ•°</div>
                            <div style="font-size: 24px; font-weight: 600; color: #667eea;" id="statTotalUsers">0</div>
                        </div>
                        <div style="background: #f8f9ff; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 12px; color: #999; margin-bottom: 5px;">æ•°æ®æ–‡ä»¶å¤¹æ•°</div>
                            <div style="font-size: 24px; font-weight: 600; color: #667eea;" id="statTotalFolders">0</div>
                        </div>
                        <div style="background: #fff5f5; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 12px; color: #999; margin-bottom: 5px;">å­¤ç«‹æ–‡ä»¶å¤¹</div>
                            <div style="font-size: 24px; font-weight: 600; color: #f56c6c;" id="statOrphanCount">0</div>
                        </div>
                        <div style="background: #fff8e6; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 12px; color: #999; margin-bottom: 5px;">ç¼ºå¤±æ–‡ä»¶å¤¹</div>
                            <div style="font-size: 24px; font-weight: 600; color: #ff9800;" id="statMissingCount">0</div>
                        </div>
                    </div>
                    
                    <!-- å­¤ç«‹æ–‡ä»¶å¤¹åˆ—è¡¨ -->
                    <div id="orphanSection" style="display: none; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="color: #f56c6c; margin: 0;">âš ï¸ å­¤ç«‹æ–‡ä»¶å¤¹ï¼ˆæœ‰æ–‡ä»¶å¤¹ä½†æ— æ•°æ®åº“è®°å½•ï¼‰</h4>
                            <button class="btn-small" onclick="cleanupOrphanFolders()" style="background: #f56c6c; color: white;">ğŸ—‘ï¸ æ¸…ç†å…¨éƒ¨</button>
                        </div>
                        <div id="orphanList" style="max-height: 200px; overflow-y: auto; background: #fff5f5; padding: 10px; border-radius: 8px;"></div>
                    </div>
                    
                    <!-- ç¼ºå¤±æ–‡ä»¶å¤¹åˆ—è¡¨ -->
                    <div id="missingSection" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="color: #ff9800; margin: 0;">âš ï¸ ç¼ºå¤±æ–‡ä»¶å¤¹ï¼ˆæœ‰æ•°æ®åº“è®°å½•ä½†æ— æ–‡ä»¶å¤¹ï¼‰</h4>
                            <button class="btn-small" onclick="createMissingFolders()" style="background: #ff9800; color: white;">ğŸ“ åˆ›å»ºå…¨éƒ¨</button>
                        </div>
                        <div id="missingList" style="max-height: 200px; overflow-y: auto; background: #fff8e6; padding: 10px; border-radius: 8px;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSystemCheck()">å…³é—­</button>
                <button class="btn" onclick="runSystemCheck()">ğŸ”„ é‡æ–°æ£€æµ‹</button>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = '../api';
        let currentAdmin = null;
        let systemCheckData = null;
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.addEventListener('DOMContentLoaded', async function() {
            await checkLogin();
            await loadStats();
            await loadUsers();
            await loadSiteSettings(); // åŠ è½½ç½‘ç«™è®¾ç½®
        });
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLogin() {
            try {
                const response = await fetch(`${API_BASE}/admin.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'check' })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentAdmin = result.data;
                    document.getElementById('adminUsername').textContent = result.data.username;
                } else {
                    // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç®¡ç†å‘˜å…¥å£ï¼ˆä¼šè‡ªåŠ¨è·¯ç”±åˆ°ç™»å½•é¡µï¼‰
                    window.location.href = '/admin';
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                // ç½‘ç»œé”™è¯¯ï¼Œä¹Ÿè·³è½¬åˆ°ç®¡ç†å‘˜å…¥å£
                window.location.href = '/admin';
            }
        }
        
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/admin.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'stats' })
                });
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('totalUsers').textContent = result.data.total_users || 0;
                    document.getElementById('activeUsers').textContent = result.data.active_users || 0;
                    document.getElementById('todayQueries').textContent = result.data.today_queries || 0;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers() {
            const loading = document.getElementById('userTableLoading');
            const container = document.getElementById('userTableContainer');
            const empty = document.getElementById('userTableEmpty');
            
            loading.style.display = 'block';
            container.style.display = 'none';
            empty.style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE}/user.php?action=list`);
                const result = await response.json();
                
                loading.style.display = 'none';
                
                if (result.success && result.data.length > 0) {
                    renderUserTable(result.data);
                    container.style.display = 'block';
                } else {
                    empty.style.display = 'block';
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                loading.style.display = 'none';
                empty.style.display = 'block';
            }
        }
        
        // æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼
        function renderUserTable(users) {
            console.log('å¼€å§‹æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼ï¼Œç”¨æˆ·æ•°é‡ï¼š', users.length);
            console.log('ç”¨æˆ·æ•°æ®ï¼š', users);
            
            const tbody = document.getElementById('userTableBody');
            if (!tbody) {
                console.error('æ‰¾ä¸åˆ°userTableBodyå…ƒç´ ');
                return;
            }
            
            try {
                tbody.innerHTML = users.map(user => {
                    // æ£€æŸ¥å¿…éœ€å­—æ®µ
                    if (!user.mobile || !user.access_token) {
                        console.error('ç”¨æˆ·æ•°æ®ç¼ºå°‘å¿…éœ€å­—æ®µï¼š', user);
                        return '';
                    }
                    
                    return `
                    <tr>
                        <td>${user.mobile}</td>
                        <td><span class="badge badge-${user.auth_type === 'full' ? 'success' : 'danger'}">${user.auth_type === 'full' ? 'å®Œæ•´è®¤è¯' : 'Cookie'}</span></td>
                        <td>
                            <code>${user.access_token.substring(0, 16)}...</code>
                            <button class="btn-small btn-edit" onclick="copyToClipboard('${user.access_url}')" title="å¤åˆ¶é“¾æ¥">ğŸ“‹</button>
                            <button class="btn-small" style="background: #10b981; color: white;" onclick="openUserPage('${user.access_url}')" title="è®¿é—®é¡µé¢">ğŸ”— è®¿é—®</button>
                        </td>
                        <td><span class="badge badge-${user.is_active ? 'success' : 'danger'}">${user.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td>
                        <td>${user.created_at}</td>
                        <td>${user.remark || '-'}</td>
                        <td>
                            <div class="actions">
                                <button class="btn-small btn-edit" onclick="editUser(${user.id}, '${user.mobile}', '${user.auth_type}', ${user.is_active})">âœï¸ ç¼–è¾‘</button>
                                <button class="btn-small btn-edit" onclick="toggleUserStatus(${user.id}, ${!user.is_active})">
                                    ${user.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}
                                </button>
                                <button class="btn-small btn-delete" onclick="deleteUser(${user.id}, '${user.mobile}')">åˆ é™¤</button>
                            </div>
                        </td>
                    </tr>
                `;
                }).join('');
                
                console.log('ç”¨æˆ·è¡¨æ ¼æ¸²æŸ“å®Œæˆ');
            } catch (error) {
                console.error('æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼æ—¶å‡ºé”™ï¼š', error);
            }
        }
        
        // æ˜¾ç¤ºæ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡†
        function showAddUserModal() {
            document.getElementById('addUserModal').classList.add('show');
        }
        
        // å…³é—­æ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡†
        function closeAddUserModal() {
            document.getElementById('addUserModal').classList.remove('show');
            // æ¸…ç©ºè¡¨å•
            document.getElementById('mobile').value = '';
            document.getElementById('appid').value = '';
            document.getElementById('tokenOnline').value = '';
            document.getElementById('cookie').value = '';
            document.getElementById('remark').value = '';
            document.getElementById('authType').value = 'full';
            toggleAuthFields();
        }
        
        // åˆ‡æ¢è®¤è¯å­—æ®µ
        function toggleAuthFields() {
            const authType = document.getElementById('authType').value;
            document.getElementById('fullAuthFields').style.display = authType === 'full' ? 'block' : 'none';
            document.getElementById('cookieAuthFields').style.display = authType === 'cookie' ? 'block' : 'none';
        }
        
        // æ·»åŠ ç”¨æˆ·
        async function addUser() {
            const authType = document.getElementById('authType').value;
            const mobile = document.getElementById('mobile').value.trim();
            const remark = document.getElementById('remark').value.trim();
            
            if (!mobile || !/^1[3-9]\d{9}$/.test(mobile)) {
                alert('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·');
                return;
            }
            
            let data = {
                action: 'add',
                auth_type: authType,
                mobile: mobile,
                remark: remark
            };
            
            if (authType === 'full') {
                const appid = document.getElementById('appid').value.trim();
                const tokenOnline = document.getElementById('tokenOnline').value.trim();
                
                if (!appid || !tokenOnline) {
                    alert('è¯·å¡«å†™å®Œæ•´çš„APPIDå’ŒTOKEN');
                    return;
                }
                
                data.appid = appid;
                data.token_online = tokenOnline;
            } else {
                const cookie = document.getElementById('cookie').value.trim();
                
                if (!cookie) {
                    alert('è¯·å¡«å†™Cookie');
                    return;
                }
                
                data.cookie = cookie;
            }
            
            try {
                const response = await fetch(`${API_BASE}/user.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('æ·»åŠ æˆåŠŸï¼');
                    closeAddUserModal();
                    await loadUsers();
                    await loadStats();
                } else {
                    alert('æ·»åŠ å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                alert('æ·»åŠ å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
        async function toggleUserStatus(userId, active) {
            try {
                const response = await fetch(`${API_BASE}/user.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'toggle_status',
                        user_id: userId,
                        is_active: active
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadUsers();
                    await loadStats();
                } else {
                    alert('æ“ä½œå¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥ï¼š' + error.message);
            }
        }
        
        // æ˜¾ç¤ºç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡†
        // æ˜¾ç¤ºç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡†
        async function editUser(userId, mobile, authType, isActive) {
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = document.getElementById('editUserModal');
            
            if (!modal) {
                alert('æ‰¾ä¸åˆ°ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡†');
                return;
            }
            
            modal.classList.add('show');
            
            // è®¾ç½®åŸºæœ¬ä¿¡æ¯
            document.getElementById('editUserId').value = userId;
            document.getElementById('editMobile').value = mobile;
            document.getElementById('editAuthType').value = authType;
            
            try {
                // åŠ è½½ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
                const users = await loadUsersData();
                const user = users.find(u => u.id === userId);
                
                if (!user) {
                    alert('æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯');
                    closeEditUserModal();
                    return;
                }
                
                // ä¿å­˜access_tokenç”¨äºåç»­æ›´æ–°
                document.getElementById('editUserToken').value = user.access_token || '';
                
                // è®¾ç½®è®¤è¯ç±»å‹å¹¶æ˜¾ç¤ºå¯¹åº”å­—æ®µ
                document.getElementById('editAuthType').value = user.auth_type;
                toggleEditAuthFields();
                
                // å¡«å……è¡¨å•æ•°æ®
                if (user.auth_type === 'full') {
                    document.getElementById('editAppid').value = user.appid || '';
                    document.getElementById('editTokenOnline').value = user.token_online || '';
                } else {
                    document.getElementById('editCookie').value = user.cookie || '';
                }
                
                document.getElementById('editRemark').value = user.remark || '';
                
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                alert('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š' + error.message);
                closeEditUserModal();
            }
        }
        
        // å…³é—­ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡†
        function closeEditUserModal() {
            document.getElementById('editUserModal').classList.remove('show');
            // æ¸…ç©ºè¡¨å•
            document.getElementById('editUserId').value = '';
            document.getElementById('editUserToken').value = '';
            document.getElementById('editMobile').value = '';
            document.getElementById('editAppid').value = '';
            document.getElementById('editTokenOnline').value = '';
            document.getElementById('editCookie').value = '';
            document.getElementById('editRemark').value = '';
        }
        
        // åˆ‡æ¢ç¼–è¾‘è¡¨å•çš„è®¤è¯å­—æ®µæ˜¾ç¤º
        function toggleEditAuthFields() {
            const authType = document.getElementById('editAuthType').value;
            const fullFields = document.getElementById('editFullAuthFields');
            const cookieFields = document.getElementById('editCookieAuthFields');
            
            if (authType === 'full') {
                fullFields.style.display = 'block';
                cookieFields.style.display = 'none';
            } else {
                fullFields.style.display = 'none';
                cookieFields.style.display = 'block';
            }
        }
        
        // ä¿å­˜ç”¨æˆ·ç¼–è¾‘
        async function saveUserEdit() {
            const userId = document.getElementById('editUserId').value;
            const mobile = document.getElementById('editMobile').value;
            const authType = document.getElementById('editAuthType').value;
            const accessToken = document.getElementById('editUserToken').value;
            const remark = document.getElementById('editRemark').value.trim();
            
            if (!mobile || !authType) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }
            
            const data = {
                action: 'update',
                user_id: userId,
                mobile: mobile,
                auth_type: authType,
                remark: remark,
                access_token: accessToken
            };
            
            // æ ¹æ®è®¤è¯ç±»å‹è·å–å¯¹åº”å­—æ®µ
            if (authType === 'full') {
                const appid = document.getElementById('editAppid').value.trim();
                const tokenOnline = document.getElementById('editTokenOnline').value.trim();
                
                if (!appid || !tokenOnline) {
                    alert('å®Œæ•´è®¤è¯éœ€è¦å¡«å†™APPIDå’ŒTOKEN_ONLINE');
                    return;
                }
                
                data.appid = appid;
                data.token_online = tokenOnline;
            } else {
                const cookie = document.getElementById('editCookie').value.trim();
                
                if (!cookie) {
                    alert('Cookieè®¤è¯éœ€è¦å¡«å†™Cookie');
                    return;
                }
                
                data.cookie = cookie;
            }
            
            try {
                const response = await fetch(`${API_BASE}/user.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('æ›´æ–°æˆåŠŸï¼');
                    closeEditUserModal();
                    await loadUsers();
                    await loadStats();
                } else {
                    alert('æ›´æ–°å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                alert('æ›´æ–°å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šåŠ è½½ç”¨æˆ·æ•°æ®ï¼ˆä¸æ¸²æŸ“è¡¨æ ¼ï¼‰
        async function loadUsersData() {
            const response = await fetch(`${API_BASE}/user.php?action=list`, {
                headers: { 'Content-Type': 'application/json' }
            });
            
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.message || 'åŠ è½½å¤±è´¥');
            }
            
            return result.data || [];
        }
        
        // åˆ é™¤ç”¨æˆ·
        async function deleteUser(userId, mobile) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${mobile} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/user.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'delete',
                        user_id: userId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('åˆ é™¤æˆåŠŸ');
                    await loadUsers();
                    await loadStats();
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // é€€å‡ºç™»å½•
        async function logout() {
            try {
                const response = await fetch(`${API_BASE}/admin.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'logout' })
                });
                
                window.location.href = 'admin_login.html';
            } catch (error) {
                window.location.href = 'admin_login.html';
            }
        }
        
        // æ‰“å¼€ç”¨æˆ·æµé‡æŸ¥è¯¢é¡µé¢
        function openUserPage(url) {
            window.open(url, '_blank');
        }
        
        // å¤åˆ¶é“¾æ¥åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }
        
        // é™çº§å¤åˆ¶æ–¹æ¡ˆ
        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š\n' + text);
            }
            document.body.removeChild(textarea);
        }
        
        // ===== ç³»ç»Ÿè‡ªæ£€åŠŸèƒ½ =====
        
        // æ˜¾ç¤ºç³»ç»Ÿè‡ªæ£€æ¨¡æ€æ¡†
        async function showSystemCheck() {
            document.getElementById('systemCheckModal').classList.add('show');
            await runSystemCheck();
        }
        
        // å…³é—­ç³»ç»Ÿè‡ªæ£€æ¨¡æ€æ¡†
        function closeSystemCheck() {
            document.getElementById('systemCheckModal').classList.remove('show');
        }
        
        // æ‰§è¡Œç³»ç»Ÿæ£€æµ‹
        async function runSystemCheck() {
            const loading = document.getElementById('checkLoading');
            const result = document.getElementById('checkResult');
            
            loading.style.display = 'block';
            result.style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE}/system.php?action=check`);
                const data = await response.json();
                
                if (data.success) {
                    systemCheckData = data.data;
                    displayCheckResult(data.data);
                } else {
                    alert('æ£€æµ‹å¤±è´¥ï¼š' + data.message);
                }
            } catch (error) {
                console.error('ç³»ç»Ÿæ£€æµ‹å¤±è´¥:', error);
                alert('æ£€æµ‹å¤±è´¥ï¼š' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // æ˜¾ç¤ºæ£€æµ‹ç»“æœ
        function displayCheckResult(data) {
            const result = document.getElementById('checkResult');
            const stats = data.stats;
            const issues = data.issues;
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            document.getElementById('statTotalUsers').textContent = stats.total_users;
            document.getElementById('statTotalFolders').textContent = stats.total_folders;
            document.getElementById('statOrphanCount').textContent = stats.orphan_count;
            document.getElementById('statMissingCount').textContent = stats.missing_count;
            
            // æ˜¾ç¤ºå¥åº·çŠ¶æ€
            const healthStatus = document.getElementById('healthStatus');
            if (stats.health_status === 'healthy') {
                healthStatus.style.background = '#e8f5e9';
                healthStatus.style.color = '#4caf50';
                healthStatus.textContent = 'âœ… ç³»ç»Ÿå¥åº·ï¼Œæ•°æ®ä¸€è‡´æ€§è‰¯å¥½';
            } else {
                healthStatus.style.background = '#fff3e0';
                healthStatus.style.color = '#ff9800';
                healthStatus.textContent = 'âš ï¸ å‘ç°æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼Œå»ºè®®å¤„ç†';
            }
            
            // æ˜¾ç¤ºå­¤ç«‹æ–‡ä»¶å¤¹åˆ—è¡¨
            const orphanSection = document.getElementById('orphanSection');
            const orphanList = document.getElementById('orphanList');
            if (issues.orphan_folders.length > 0) {
                orphanSection.style.display = 'block';
                orphanList.innerHTML = issues.orphan_folders.map(item => `
                    <div style="padding: 8px; margin-bottom: 5px; background: white; border-radius: 4px; font-size: 12px;">
                        <div style="font-weight: 600; color: #333;">${item.path}</div>
                        <div style="color: #999; margin-top: 2px;">å¤§å°: ${formatBytes(item.size)}</div>
                    </div>
                `).join('');
            } else {
                orphanSection.style.display = 'none';
            }
            
            // æ˜¾ç¤ºç¼ºå¤±æ–‡ä»¶å¤¹åˆ—è¡¨
            const missingSection = document.getElementById('missingSection');
            const missingList = document.getElementById('missingList');
            if (issues.missing_folders.length > 0) {
                missingSection.style.display = 'block';
                missingList.innerHTML = issues.missing_folders.map(item => `
                    <div style="padding: 8px; margin-bottom: 5px; background: white; border-radius: 4px; font-size: 12px;">
                        <div style="font-weight: 600; color: #333;">ç”¨æˆ·: ${item.mobile} (ID: ${item.user_id})</div>
                        <div style="color: #999; margin-top: 2px;">ç¼ºå¤±: ${item.expected_path}</div>
                    </div>
                `).join('');
            } else {
                missingSection.style.display = 'none';
            }
            
            result.style.display = 'block';
        }
        
        // æ¸…ç†å­¤ç«‹æ–‡ä»¶å¤¹
        async function cleanupOrphanFolders() {
            if (!systemCheckData || !systemCheckData.issues.orphan_folders.length) {
                alert('æ²¡æœ‰éœ€è¦æ¸…ç†çš„å­¤ç«‹æ–‡ä»¶å¤¹');
                return;
            }
            
            const count = systemCheckData.issues.orphan_folders.length;
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${count} ä¸ªå­¤ç«‹æ–‡ä»¶å¤¹å—ï¼Ÿ\n\nè¿™äº›æ–‡ä»¶å¤¹æ²¡æœ‰å¯¹åº”çš„æ•°æ®åº“è®°å½•ï¼Œåˆ é™¤åæ— æ³•æ¢å¤ï¼`)) {
                return;
            }
            
            const tokens = systemCheckData.issues.orphan_folders.map(item => item.token);
            
            try {
                const response = await fetch(`${API_BASE}/system.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'cleanup_orphan',
                        tokens: tokens
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`æ¸…ç†å®Œæˆï¼\næˆåŠŸ: ${result.data.cleaned} ä¸ª\nå¤±è´¥: ${result.data.failed} ä¸ª`);
                    await runSystemCheck(); // é‡æ–°æ£€æµ‹
                } else {
                    alert('æ¸…ç†å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('æ¸…ç†å¤±è´¥:', error);
                alert('æ¸…ç†å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // åˆ›å»ºç¼ºå¤±æ–‡ä»¶å¤¹
        async function createMissingFolders() {
            if (!systemCheckData || !systemCheckData.issues.missing_folders.length) {
                alert('æ²¡æœ‰éœ€è¦åˆ›å»ºçš„æ–‡ä»¶å¤¹');
                return;
            }
            
            const count = systemCheckData.issues.missing_folders.length;
            if (!confirm(`ç¡®å®šè¦ä¸º ${count} ä¸ªç”¨æˆ·åˆ›å»ºæ•°æ®æ–‡ä»¶å¤¹å—ï¼Ÿ`)) {
                return;
            }
            
            const tokens = systemCheckData.issues.missing_folders.map(item => item.token);
            
            try {
                const response = await fetch(`${API_BASE}/system.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'create_missing',
                        tokens: tokens
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`åˆ›å»ºå®Œæˆï¼\næˆåŠŸ: ${result.data.created} ä¸ª\nå¤±è´¥: ${result.data.failed} ä¸ª`);
                    await runSystemCheck(); // é‡æ–°æ£€æµ‹
                } else {
                    alert('åˆ›å»ºå¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('åˆ›å»ºå¤±è´¥:', error);
                alert('åˆ›å»ºå¤±è´¥ï¼š' + error.message);
            }
        }
        
        // æ ¼å¼åŒ–å­—èŠ‚æ•°
        // æ ¼å¼åŒ–å­—èŠ‚æ•°
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        // ===== æ ‡ç­¾é¡µåˆ‡æ¢ =====
        
        function switchAdminTab(tab) {
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            
            // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.getElementById(tab + 'Tab').style.display = 'block';
            
            // åŠ è½½å¯¹åº”æ•°æ®
            if (tab === 'activation') {
                loadActivationCodes();
            } else if (tab === 'admins') {
                loadAdmins();
            } else if (tab === 'settings') {
                loadSiteSettings();
            }
        }
        
        // ===== æ¿€æ´»ç ç®¡ç† =====
        
        async function loadActivationCodes() {
            try {
                // åŠ è½½ç»Ÿè®¡
                const statsResp = await fetch(`${API_BASE}/../activecode/api.php?action=stats`);
                const statsData = await statsResp.json();
                
                if (statsData.success) {
                    document.getElementById('codeTotal').textContent = statsData.data.total;
                    document.getElementById('codeUnused').textContent = statsData.data.unused;
                    document.getElementById('codeUsed').textContent = statsData.data.used;
                    document.getElementById('codeExpired').textContent = statsData.data.expired;
                }
                
                // åŠ è½½åˆ—è¡¨
                const listResp = await fetch(`${API_BASE}/../activecode/api.php?action=list`);
                const listData = await listResp.json();
                
                if (listData.success) {
                    renderActivationCodes(listData.data);
                }
            } catch (error) {
                console.error('åŠ è½½æ¿€æ´»ç å¤±è´¥:', error);
            }
        }
        
        function renderActivationCodes(codes) {
            const tbody = document.getElementById('codeTableBody');
            tbody.innerHTML = codes.map(code => `
                <tr>
                    <td><input type="checkbox" class="code-checkbox" value="${code.id}"></td>
                    <td><code>${code.code}</code></td>
                    <td>
                        <span class="badge badge-${
                            code.status === 'unused' ? 'success' : 
                            code.status === 'used' ? 'warning' : 'danger'
                        }">${
                            code.status === 'unused' ? 'æœªä½¿ç”¨' : 
                            code.status === 'used' ? 'å·²ä½¿ç”¨' : 'å·²è¿‡æœŸ'
                        }</span>
                    </td>
                    <td>${code.used_by_mobile || '-'}</td>
                    <td>${code.created_at || '-'}</td>
                    <td>${code.used_at || '-'}</td>
                    <td>${code.remark || '-'}</td>
                    <td>
                        <button class="btn-small btn-delete" onclick="deleteSingleCode(${code.id})">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function showGenerateCodeModal() {
            document.getElementById('generateCodeModal').classList.add('show');
        }
        
        function closeGenerateCodeModal() {
            document.getElementById('generateCodeModal').classList.remove('show');
            document.getElementById('generateCount').value = 1;
            document.getElementById('generateRemark').value = '';
        }
        
        async function generateCodes() {
            const count = parseInt(document.getElementById('generateCount').value);
            const remark = document.getElementById('generateRemark').value;
            
            if (count < 1 || count > 100) {
                alert('ç”Ÿæˆæ•°é‡å¿…é¡»åœ¨1-100ä¹‹é—´');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/../activecode/api.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'generate',
                        count: count,
                        remark: remark
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`æˆåŠŸç”Ÿæˆ ${result.data.length} ä¸ªæ¿€æ´»ç ï¼`);
                    closeGenerateCodeModal();
                    await loadActivationCodes();
                } else {
                    alert('ç”Ÿæˆå¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('ç”Ÿæˆæ¿€æ´»ç å¤±è´¥:', error);
                alert('ç”Ÿæˆå¤±è´¥ï¼š' + error.message);
            }
        }
        
        function toggleAllCodes(checkbox) {
            document.querySelectorAll('.code-checkbox').forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }
        
        async function deleteSelectedCodes() {
            const checked = Array.from(document.querySelectorAll('.code-checkbox:checked')).map(cb => parseInt(cb.value));
            
            if (checked.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ¿€æ´»ç ');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${checked.length} ä¸ªæ¿€æ´»ç å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/../activecode/api.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'delete',
                        ids: checked
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`æˆåŠŸåˆ é™¤ ${result.deleted} ä¸ªæ¿€æ´»ç `);
                    await loadActivationCodes();
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }
        
        async function deleteSingleCode(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¿€æ´»ç å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/../activecode/api.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'delete',
                        ids: [id]
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('åˆ é™¤æˆåŠŸ');
                    await loadActivationCodes();
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }
        
        function exportCodes() {
            const codes = Array.from(document.querySelectorAll('#codeTableBody code')).map(el => el.textContent);
            
            if (codes.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ¿€æ´»ç ');
                return;
            }
            
            const text = codes.join('\n');
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `activation_codes_${new Date().getTime()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // ===== ç®¡ç†å‘˜ç®¡ç† =====
        
        async function loadAdmins() {
            try {
                const response = await fetch(`${API_BASE}/admin.php?action=list`);
                const result = await response.json();
                
                if (result.success) {
                    renderAdmins(result.data);
                }
            } catch (error) {
                console.error('åŠ è½½ç®¡ç†å‘˜å¤±è´¥:', error);
            }
        }
        
        function renderAdmins(admins) {
            const tbody = document.getElementById('adminTableBody');
            tbody.innerHTML = admins.map(admin => `
                <tr>
                    <td>${admin.id}</td>
                    <td>${admin.username}</td>
                    <td>${admin.email || '-'}</td>
                    <td>${admin.created_at}</td>
                    <td>
                        <button class="btn-small btn-edit" onclick="showEditAdminUsernameModal(${admin.id}, '${admin.username}')">æ”¹å</button>
                        <button class="btn-small btn-edit" onclick="showEditAdminPasswordModal(${admin.id})">æ”¹å¯†ç </button>
                        <button class="btn-small btn-delete" onclick="deleteAdmin(${admin.id})">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function showEditAdminUsernameModal(id, username) {
            document.getElementById('editAdminId').value = id;
            document.getElementById('editAdminUsername').value = username;
            document.getElementById('editAdminUsernameModal').classList.add('show');
        }
        
        function closeEditAdminUsernameModal() {
            document.getElementById('editAdminUsernameModal').classList.remove('show');
        }
        
        async function saveAdminUsername() {
            const id = document.getElementById('editAdminId').value;
            const username = document.getElementById('editAdminUsername').value.trim();
            
            if (!username) {
                alert('ç”¨æˆ·åä¸èƒ½ä¸ºç©º');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'update_username',
                        id: id,
                        username: username
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ä¿®æ”¹æˆåŠŸï¼');
                    closeEditAdminUsernameModal();
                    await loadAdmins();
                } else {
                    alert('ä¿®æ”¹å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('ä¿®æ”¹å¤±è´¥:', error);
                alert('ä¿®æ”¹å¤±è´¥ï¼š' + error.message);
            }
        }
        
        function showEditAdminPasswordModal(id) {
            document.getElementById('editPasswordAdminId').value = id;
            document.getElementById('editAdminPassword').value = '';
            document.getElementById('editAdminPasswordConfirm').value = '';
            document.getElementById('editAdminPasswordModal').classList.add('show');
        }
        
        function closeEditAdminPasswordModal() {
            document.getElementById('editAdminPasswordModal').classList.remove('show');
        }
        
        async function saveAdminPassword() {
            const id = document.getElementById('editPasswordAdminId').value;
            const password = document.getElementById('editAdminPassword').value;
            const confirm = document.getElementById('editAdminPasswordConfirm').value;
            
            if (!password) {
                alert('å¯†ç ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            if (password !== confirm) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }
            
            if (password.length < 6) {
                alert('å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä¸ªå­—ç¬¦');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'update_password',
                        id: id,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼');
                    closeEditAdminPasswordModal();
                } else {
                    alert('ä¿®æ”¹å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('ä¿®æ”¹å¤±è´¥:', error);
                alert('ä¿®æ”¹å¤±è´¥ï¼š' + error.message);
            }
        }
        
        async function deleteAdmin(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç®¡ç†å‘˜å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'delete',
                        id: id
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('åˆ é™¤æˆåŠŸï¼');
                    await loadAdmins();
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // ===== ç½‘ç«™è®¾ç½® =====
        
        async function loadSiteSettings() {
            try {
                const response = await fetch(`${API_BASE}/system.php?action=config`);
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('siteMode').value = result.data.site_mode;
                }
            } catch (error) {
                console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
            }
        }
        
        async function updateSiteMode() {
            const mode = document.getElementById('siteMode').value;
            
            if (!confirm(`ç¡®å®šè¦åˆ‡æ¢åˆ°${mode === 'public' ? 'å…¬å¼€æ³¨å†Œ' : 'ç§æœ‰'}æ¨¡å¼å—ï¼Ÿ`)) {
                await loadSiteSettings(); // æ¢å¤åŸå€¼
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/system.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'update_config',
                        site_mode: mode
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                } else {
                    alert('è®¾ç½®å¤±è´¥ï¼š' + result.message);
                    await loadSiteSettings();
                }
            } catch (error) {
                console.error('è®¾ç½®å¤±è´¥:', error);
                alert('è®¾ç½®å¤±è´¥ï¼š' + error.message);
                await loadSiteSettings();
            }
        }
    </script>
</body>
</html>
